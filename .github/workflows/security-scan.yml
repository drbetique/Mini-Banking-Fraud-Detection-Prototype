name: Security Scanning

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggers
  pull_request:
    paths:
      - 'requirements.txt'
      - 'Dockerfile*'
      - '.github/workflows/security-scan.yml'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==================== DEPENDENCY VULNERABILITY SCANNING ====================
  dependency-scan:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety pip-audit

      - name: Run Safety check
        run: |
          safety check --json --output safety-report.json
        continue-on-error: true

      - name: Run pip-audit
        run: |
          pip-audit --format json --output pip-audit-report.json
        continue-on-error: true

      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-vulnerability-report
          path: safety-report.json

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: pip-audit-report.json

  # ==================== CODE SECURITY SCANNING ====================
  code-scan:
    name: Scan Code for Security Issues
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: |
          pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          bandit -r . -f json -o bandit-report.json \
            --exclude ./tests,./venv,./mlflow \
            --severity-level medium

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

      - name: Run Bandit (fail on high severity)
        run: |
          bandit -r . --severity-level high \
            --exclude ./tests,./venv,./mlflow

  # ==================== DOCKER IMAGE SCANNING ====================
  container-scan:
    name: Scan Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build API Docker image
        run: |
          docker build -f Dockerfile.api -t fraud-detection-api:test .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: fraud-detection-api:test
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy (JSON report)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: fraud-detection-api:test
          format: 'json'
          output: 'trivy-report.json'

      - name: Upload Trivy JSON report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-container-scan-report
          path: trivy-report.json

  # ==================== SECRET SCANNING ====================
  secret-scan:
    name: Scan for Exposed Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== LICENSE COMPLIANCE ====================
  license-scan:
    name: Check License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-licenses
        run: |
          pip install pip-licenses

      - name: Install project dependencies
        run: |
          pip install -r requirements.txt

      - name: Generate license report
        run: |
          pip-licenses --format=json --output-file=licenses.json
          pip-licenses --format=markdown --output-file=licenses.md

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            licenses.json
            licenses.md

      - name: Check for GPL licenses (fail if found)
        run: |
          # Fail if GPL licenses are detected (incompatible with proprietary code)
          pip-licenses | grep -i "GPL" && exit 1 || exit 0
        continue-on-error: true

  # ==================== GENERATE SECURITY REPORT ====================
  generate-report:
    name: Generate Security Summary Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-scan, container-scan, license-scan]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate summary report
        run: |
          echo "# Security Scan Summary Report" > security-summary.md
          echo "**Date:** $(date)" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Scans Completed" >> security-summary.md
          echo "- ✅ Dependency Vulnerability Scan" >> security-summary.md
          echo "- ✅ Code Security Scan (Bandit)" >> security-summary.md
          echo "- ✅ Container Image Scan (Trivy)" >> security-summary.md
          echo "- ✅ Secret Scan (Gitleaks)" >> security-summary.md
          echo "- ✅ License Compliance Check" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Reports" >> security-summary.md
          echo "Download detailed reports from workflow artifacts." >> security-summary.md

      - name: Upload summary report
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-report
          path: security-summary.md

  # ==================== NOTIFY TEAM ====================
  notify:
    name: Notify Security Team
    runs-on: ubuntu-latest
    needs: [generate-report]
    if: failure()

    steps:
      - name: Send notification
        run: |
          echo "⚠️ Security scan detected issues. Please review the reports."
          # Add notification logic here (Slack, email, etc.)
          # Example:
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -d '{"text":"⚠️ Security scan failed. Check GitHub Actions for details."}'
